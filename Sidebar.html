<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&display=swap">
    <style>
        body {
            font-family: 'Outfit', sans-serif;
            padding: 20px;
            background-color: #f8f9fa;
            color: #333;
        }

        .card {
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        h2 {
            font-size: 16px;
            margin-top: 0;
            color: #1a73e8;
        }

        .input-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            font-size: 12px;
            margin-bottom: 5px;
            color: #666;
        }

        select,
        input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-family: inherit;
        }

        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 10px;
        }

        .btn-primary {
            background-color: #1a73e8;
            color: white;
        }

        .btn-primary:hover {
            background-color: #1557b0;
        }

        .status {
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pulse {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ccc;
        }

        .online {
            background: #238636;
            box-shadow: 0 0 8px #238636;
        }

        .offline {
            background: #d73a49;
        }
    </style>
</head>

<body>
    <div class="card">
        <div class="status" id="status-area">
            <div class="pulse" id="status-dot"></div>
            <span id="status-text">Zji≈°≈•ov√°n√≠ stavu...</span>
        </div>
    </div>

    <div class="card">
        <h2>Konfigurace sloupc≈Ø</h2>
        <div class="input-group">
            <label>Popis polo≈æky (A, B, C...)</label>
            <input type="text" id="col-desc" value="C">
        </div>
        <div class="input-group">
            <label>C√≠lov√Ω sloupec pro cenu (F, G...)</label>
            <input type="text" id="col-price" value="F">
        </div>
        <div class="input-group">
            <label>Typ ceny</label>
            <select id="price-type">
                <option value="material">üì¶ Materi√°l</option>
                <option value="labor">üîß Mont√°≈æ</option>
            </select>
        </div>
        <button class="btn btn-primary" onclick="runPricing()">üöÄ Ocenit v√Ωbƒõr</button>
    </div>

    <div class="card">
        <h2>Historie cen</h2>
        <div class="input-group" style="display: flex; gap: 8px;">
            <input type="text" id="hist-search" placeholder="Zadejte n√°zev polo≈æky..." style="flex: 1;">
            <button class="btn" style="width: auto; padding: 8px 12px; background: #e8f0fe; color: #1a73e8;"
                onclick="loadFromCell()" title="Naƒç√≠st z vybran√© bu≈àky">üìã</button>
        </div>
        <button class="btn btn-primary" onclick="showHistory()">üîç Zobrazit graf</button>

        <div id="chart-container" style="margin-top: 15px; display: none;">
            <p id="chart-title" style="font-size: 13px; font-weight: 600; margin-bottom: 10px;"></p>
            <canvas id="priceChart"></canvas>
        </div>
    </div>

    <div class="card">
        <h2>‚öôÔ∏è Feedback</h2>
        <p style="font-size: 11px; color: #666; margin-bottom: 10px;">Vyberte bu≈àku s ocenƒõn√≠m a pou≈æijte akce n√≠≈æe.</p>

        <button class="btn" style="background: #fce8e6; color: #c5221f;" onclick="blacklistItem()">üóëÔ∏è Smazat polo≈æku z
            DB</button>

        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;">
            <p style="font-size: 11px; color: #666; margin-bottom: 8px;">P≈ôidat vlastn√≠ cenu:</p>
            <div class="input-group">
                <input type="text" id="custom-name" placeholder="N√°zev polo≈æky">
            </div>
            <div style="display: flex; gap: 8px;">
                <div class="input-group" style="flex: 1;">
                    <input type="number" id="custom-price-mat" placeholder="Materi√°l" step="0.01">
                </div>
                <div class="input-group" style="flex: 1;">
                    <input type="number" id="custom-price-lab" placeholder="Mont√°≈æ" step="0.01">
                </div>
            </div>
            <button class="btn btn-primary" onclick="addCustomPrice()">‚ûï P≈ôidat do DB</button>
        </div>
    </div>

    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        let myChart = null;

        function runPricing() {
            const desc = document.getElementById('col-desc').value;
            const price = document.getElementById('col-price').value;
            const priceType = document.getElementById('price-type').value;

            const btn = document.querySelector('button[onclick="runPricing()"]');
            btn.innerText = "‚è≥ Zpracov√°v√°m...";
            btn.disabled = true;

            google.script.run
                .withSuccessHandler(() => {
                    btn.innerText = "üöÄ Ocenit v√Ωbƒõr";
                    btn.disabled = false;
                })
                .withFailureHandler((err) => {
                    alert("Chyba: " + err);
                    btn.innerText = "üöÄ Ocenit v√Ωbƒõr";
                    btn.disabled = false;
                })
                .priceSelection(desc, price, priceType);
        }

        function loadFromCell() {
            google.script.run
                .withSuccessHandler((value) => {
                    if (value) {
                        document.getElementById('hist-search').value = value;
                        // Tak√© vyplnit n√°zev pro custom cenu
                        document.getElementById('custom-name').value = value;
                    }
                })
                .getActiveCellValue();
        }

        function blacklistItem() {
            if (!confirm("Opravdu chcete smazat tuto polo≈æku z datab√°ze?")) return;

            google.script.run
                .withSuccessHandler((itemId) => {
                    if (!itemId) {
                        alert("Vyberte bu≈àku s ocenƒõn√≠m (mus√≠ m√≠t pozn√°mku s ID).");
                        return;
                    }

                    google.script.run
                        .withSuccessHandler((result) => {
                            if (result.success) {
                                alert("Polo≈æka smaz√°na z datab√°ze.");
                            } else {
                                alert("Chyba: " + (result.error || "Nezn√°m√° chyba"));
                            }
                        })
                        .deleteItem(itemId);
                })
                .getItemIdFromActiveCell();
        }

        function addCustomPrice() {
            const name = document.getElementById('custom-name').value;
            const priceMat = parseFloat(document.getElementById('custom-price-mat').value) || 0;
            const priceLab = parseFloat(document.getElementById('custom-price-lab').value) || 0;

            if (!name) {
                alert("Zadejte n√°zev polo≈æky.");
                return;
            }

            const btn = document.querySelector('button[onclick="addCustomPrice()"]');
            btn.innerText = "‚è≥ Ukl√°d√°m...";
            btn.disabled = true;

            google.script.run
                .withSuccessHandler((result) => {
                    btn.innerText = "‚ûï P≈ôidat do DB";
                    btn.disabled = false;

                    if (result.success) {
                        alert("Polo≈æka p≈ôid√°na do datab√°ze!");
                        // Vyƒçistit formul√°≈ô
                        document.getElementById('custom-name').value = '';
                        document.getElementById('custom-price-mat').value = '';
                        document.getElementById('custom-price-lab').value = '';
                    } else {
                        alert("Chyba: " + (result.error || "Nezn√°m√° chyba"));
                    }
                })
                .withFailureHandler((err) => {
                    btn.innerText = "‚ûï P≈ôidat do DB";
                    btn.disabled = false;
                    alert("Chyba: " + err);
                })
                .addCustomItem(name, priceMat, priceLab, 'ks');
        }

        function showHistory() {
            const query = document.getElementById('hist-search').value;
            if (!query) return;

            const btn = document.querySelector('button[onclick="showHistory()"]');
            const originalText = btn.innerText;
            btn.innerText = "Naƒç√≠t√°m...";
            btn.disabled = true;

            google.script.run
                .withSuccessHandler((data) => {
                    btn.innerText = originalText;
                    btn.disabled = false;

                    if (data && data.history) {
                        renderChart(data.itemName, data.history);
                    } else {
                        alert("Polo≈æka nenalezena nebo nem√° historii.");
                    }
                })
                .withFailureHandler((err) => {
                    alert("Chyba: " + err);
                    btn.innerText = originalText;
                    btn.disabled = false;
                })
                .getItemHistory(query);
        }

        function renderChart(itemName, historyData) {
            document.getElementById('chart-container').style.display = 'block';
            document.getElementById('chart-title').innerText = itemName;

            const ctx = document.getElementById('priceChart').getContext('2d');

            // Prepare data: Sort by date
            historyData.sort((a, b) => new Date(a.date) - new Date(b.date));

            const labels = historyData.map(d => d.date);
            const prices = historyData.map(d => d.price_material + d.price_labor);

            if (myChart) {
                myChart.destroy();
            }

            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Cena (Mat + Pr√°ce)',
                        data: prices,
                        borderColor: '#1a73e8',
                        tension: 0.1,
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
        }

        // Periodicky kontrolovat stav backendu
        setInterval(() => {
            google.script.run.withSuccessHandler((status) => {
                const dot = document.getElementById('status-dot');
                const text = document.getElementById('status-text');
                if (status && status.total_items !== undefined) {
                    dot.className = 'pulse online';
                    text.innerText = 'Online (' + status.total_items + ' polo≈æek)';
                } else {
                    dot.className = 'pulse offline';
                    text.innerText = 'Offline';
                }
            }).getBackendStatus();
        }, 5000);
    </script>
</body>

</html>