<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&display=swap">
    <style>
        body {
            font-family: 'Outfit', sans-serif;
            padding: 20px;
            background-color: #f8f9fa;
            color: #333;
        }

        .card {
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        h2 {
            font-size: 16px;
            margin-top: 0;
            color: #1a73e8;
        }

        .input-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            font-size: 12px;
            margin-bottom: 5px;
            color: #666;
        }

        select,
        input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-family: inherit;
        }

        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 10px;
        }

        .btn-primary {
            background-color: #1a73e8;
            color: white;
        }

        .btn-primary:hover {
            background-color: #1557b0;
        }

        .status {
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pulse {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ccc;
        }

        .online {
            background: #238636;
            box-shadow: 0 0 8px #238636;
        }

        .offline {
            background: #d73a49;
        }
    </style>
</head>

<body>
    <div class="card">
        <div class="status" id="status-area">
            <div class="pulse" id="status-dot"></div>
            <span id="status-text">Zji코콘ov치n칤 stavu...</span>
        </div>
    </div>

    <div class="card">
        <h2>Konfigurace sloupc콢</h2>
        <div class="input-group">
            <label>Popis polo쬶y (A, B, C...)</label>
            <input type="text" id="col-desc" value="C">
        </div>
        <div class="input-group">
            <label>C칤lov칳 sloupec pro cenu (F, G...)</label>
            <input type="text" id="col-price" value="F">
        </div>
    </div>

    <div class="card">
        <h2>Historie cen</h2>
        <div class="input-group">
            <input type="text" id="hist-search" placeholder="Zadejte n치zev polo쬶y...">
        </div>
        <button class="btn btn-primary" onclick="showHistory()">游댌 Zobrazit graf</button>

        <div id="chart-container" style="margin-top: 15px; display: none;">
            <p id="chart-title" style="font-size: 13px; font-weight: 600; margin-bottom: 10px;"></p>
            <canvas id="priceChart"></canvas>
        </div>
    </div>

    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        let myChart = null;

        function runPricing() {
            const desc = document.getElementById('col-desc').value;
            const price = document.getElementById('col-price').value;

            google.script.run
                .withSuccessHandler(() => {
                    // Hotovo
                })
                .priceSelection(desc, price);
        }

        function showHistory() {
            const query = document.getElementById('hist-search').value;
            if (!query) return;

            const btn = document.querySelector('button[onclick="showHistory()"]');
            const originalText = btn.innerText;
            btn.innerText = "Na캜칤t치m...";
            btn.disabled = true;

            google.script.run
                .withSuccessHandler((data) => {
                    btn.innerText = originalText;
                    btn.disabled = false;

                    if (data && data.history) {
                        renderChart(data.itemName, data.history);
                    } else {
                        alert("Polo쬶a nenalezena nebo nem치 historii.");
                    }
                })
                .withFailureHandler((err) => {
                    alert("Chyba: " + err);
                    btn.innerText = originalText;
                    btn.disabled = false;
                })
                .getItemHistory(query);
        }

        function renderChart(itemName, historyData) {
            document.getElementById('chart-container').style.display = 'block';
            document.getElementById('chart-title').innerText = itemName;

            const ctx = document.getElementById('priceChart').getContext('2d');

            // Prepare data: Sort by date
            historyData.sort((a, b) => new Date(a.date) - new Date(b.date));

            const labels = historyData.map(d => d.date);
            const prices = historyData.map(d => d.price_material + d.price_labor);

            if (myChart) {
                myChart.destroy();
            }

            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Cena (Mat + Pr치ce)',
                        data: prices,
                        borderColor: '#1a73e8',
                        tension: 0.1,
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
        }

        // Periodicky kontrolovat stav backendu
        setInterval(() => {
            google.script.run.withSuccessHandler((status) => {
                const dot = document.getElementById('status-dot');
                const text = document.getElementById('status-text');
                if (status && status.total_items !== undefined) {
                    dot.className = 'pulse online';
                    text.innerText = 'Online (' + status.total_items + ' polo쬰k)';
                } else {
                    dot.className = 'pulse offline';
                    text.innerText = 'Offline';
                }
            }).getBackendStatus();
        }, 5000);
    </script>
</body>

</html>