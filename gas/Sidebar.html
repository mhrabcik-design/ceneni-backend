<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600&display=swap">
    <style>
        :root {
            --google-blue: #1a73e8;
            --google-blue-hover: #1557b0;
            --border-color: #dadce0;
            --bg-color: #ffffff;
            --secondary-bg: #f8f9fa;
            --text-main: #3c4043;
            --text-secondary: #70757a;
            --error-red: #d93025;
            --success-green: #1e8e3e;
            --warning-orange: #f9ab00;
        }

        body {
            font-family: 'Outfit', sans-serif;
            margin: 0;
            padding: 16px;
            background-color: var(--secondary-bg);
            color: var(--text-main);
            display: flex;
            flex-direction: column;
            gap: 16px;
            font-size: 13px;
        }

        /* Status Badge */
        .status-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 11px;
            font-weight: 500;
        }

        .pulse {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ccc;
        }

        .pulse.online {
            background: var(--success-green);
        }

        .pulse.offline {
            background: var(--error-red);
        }

        /* Card Section */
        .section-card {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 1px 2px 0 rgba(60, 64, 67, .3), 0 1px 3px 1px rgba(60, 64, 67, .15);
            position: relative;
        }

        h2 {
            font-size: 14px;
            font-weight: 600;
            margin: 0 0 16px 0;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 12px;
        }

        label {
            display: block;
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: 4px;
            font-weight: 500;
        }

        input,
        select {
            width: 100%;
            background: white;
            border: 1px solid var(--border-color);
            color: var(--text-main);
            padding: 8px 12px;
            border-radius: 4px;
            font-family: inherit;
            font-size: 13px;
            box-sizing: border-box;
            transition: all 0.2s;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: var(--google-blue);
            box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
        }

        /* Buttons */
        .btn {
            width: 100%;
            padding: 10px 16px;
            border: 1px solid transparent;
            border-radius: 4px;
            font-family: inherit;
            font-weight: 500;
            font-size: 13px;
            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s;
        }

        .btn-primary {
            background: var(--google-blue);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--google-blue-hover);
            box-shadow: 0 1px 3px 1px rgba(60, 64, 67, .15), 0 1px 2px 0 rgba(60, 64, 67, .3);
        }

        .btn-outline {
            background: white;
            color: var(--google-blue);
            border-color: var(--border-color);
        }

        .btn-outline:hover:not(:disabled) {
            background: #f6fafe;
            border-color: var(--google-blue);
        }

        .btn-danger {
            background: white;
            color: var(--error-red);
            border-color: var(--border-color);
        }

        .btn-danger:hover:not(:disabled) {
            background: #fdf2f2;
            border-color: var(--error-red);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Candidates List */
        .candidates-list {
            margin-top: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .candidate-item {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            background: #fff;
        }

        .candidate-item:hover {
            border-color: var(--google-blue);
            background: #f8fbff;
            transform: translateY(-1px);
        }

        .candidate-name {
            font-weight: 600;
            font-size: 12px;
            margin-bottom: 4px;
            display: block;
        }

        .candidate-meta {
            font-size: 10px;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
        }

        .candidate-source {
            color: var(--google-blue);
            font-weight: 500;
        }

        .candidate-score {
            background: #e8f0fe;
            padding: 2px 6px;
            border-radius: 10px;
            color: var(--google-blue);
        }

        /* Chart & Table */
        .results-container {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }

        #chart-title {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .comp-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
            margin-top: 12px;
        }

        .comp-table th {
            text-align: left;
            color: var(--text-secondary);
            padding: 6px;
            border-bottom: 2px solid var(--border-color);
        }

        .comp-table td {
            padding: 8px 6px;
            border-bottom: 1px solid var(--border-color);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--secondary-bg);
        }

        ::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #999;
        }
    </style>
</head>

<body>

    <!-- Status -->
    <div class="status-badge">
        <div class="pulse" id="status-dot"></div>
        <span id="status-text">Zji코콘ov치n칤 stavu...</span>
    </div>

    <!-- Selection Helper (Automatic Menu) -->
    <div id="selection-panel" class="section-card" style="display: none; border-left: 4px solid var(--warning-orange);">
        <h2 style="color: var(--warning-orange);">游눠 N치vrhy pro v치코 v칳b캩r</h2>
        <div id="target-info" style="font-size: 11px; color: var(--text-secondary); margin-bottom: 8px;"></div>
        <div id="candidates-container" class="candidates-list">
            <!-- Populated by JS -->
        </div>
    </div>

    <!-- Main Pricing -->
    <div class="section-card">
        <h2>游 Automatick칠 oce켿ov치n칤</h2>
        <div style="display: flex; gap: 8px; margin-bottom: 12px;">
            <div style="flex: 1;">
                <label>Popis</label>
                <input type="text" id="col-desc" value="C" onchange="saveSettings()">
            </div>
            <div style="flex: 1;">
                <label>Materi치l</label>
                <input type="text" id="col-material" value="I" onchange="saveSettings()">
            </div>
            <div style="flex: 1;">
                <label>Pr치ce</label>
                <input type="text" id="col-labor" value="J" onchange="saveSettings()">
            </div>
        </div>
        <button class="btn btn-primary" onclick="runPricing()" id="btn-run">Ocenit ozna캜en칳 v칳b캩r</button>
        <button class="btn btn-outline" style="margin-top: 8px;" onclick="showCandidatesManual()" id="btn-candidates">
            游댌 Zobrazit kandid치ty pro bu켿ku
        </button>
    </div>

    <!-- History & Analysis -->
    <div class="section-card">
        <h2>游늵 Historie a anal칳za</h2>
        <div style="display: flex; gap: 4px; margin-bottom: 12px;">
            <input type="text" id="hist-search" placeholder="Hledat polo쬶u v DB...">
            <button class="btn btn-outline" style="width: 44px; padding: 0;" onclick="loadFromCell()"
                title="Na캜칤st z bu켿ky">游늶</button>
        </div>
        <button class="btn btn-outline" onclick="showHistory()" id="btn-hist">Zobrazit v칳voj ceny</button>

        <div id="chart-container" class="results-container" style="display: none;">
            <div id="chart-title"></div>
            <canvas id="priceChart"></canvas>

            <div style="margin-top: 16px;">
                <label>P콏ehled dodavatel콢</label>
                <div id="comparison-table" style="max-height: 180px; overflow-y: auto;"></div>
            </div>
        </div>
    </div>

    <!-- Settings & Tools -->
    <div class="section-card">
        <h2>丘뙖잺 Nastaven칤 syst칠mu</h2>
        <div class="form-group">
            <label>Citlivost shody (Threshold: <span id="val-threshold">40</span>%)</label>
            <input type="range" id="threshold" min="0" max="100" value="40" step="5" oninput="updateRangeLabel()"
                onchange="saveSettings()">
            <p style="font-size: 10px; color: var(--text-secondary); margin-top: 4px;">Polo쬶y se shodou ni쮄뫆 ne tato
                hodnota nebudou ocen캩ny automaticky.</p>
        </div>

        <button class="btn btn-danger" onclick="blacklistItem()">
            Odstranit polo쬶u z datab치ze
        </button>

        <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color);">
            <label>P콏idat novou cenu ru캜n캩</label>
            <input type="text" id="custom-name" placeholder="N치zev nov칠 polo쬶y" style="margin-bottom: 8px;">
            <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                <input type="number" id="custom-price-mat" placeholder="Mat. [K캜]">
                <input type="number" id="custom-price-lab" placeholder="Pr치ce [K캜]">
            </div>
            <button class="btn btn-outline" onclick="addCustomPrice()" id="btn-add">
                Ulo쬴t do datab치ze
            </button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let myChart = null;
        let lastCellKey = "";

        // On Load
        window.onload = function () {
            initSettings();
            startPolling();
        };

        function initSettings() {
            google.script.run.withSuccessHandler((s) => {
                if (!s) return;
                document.getElementById('threshold').value = s.threshold * 100;
                document.getElementById('val-threshold').innerText = Math.round(s.threshold * 100);
                document.getElementById('col-desc').value = s.colDesc;
                document.getElementById('col-material').value = s.colMaterial;
                document.getElementById('col-labor').value = s.colLabor;
            }).getSettings();
        }

        function updateRangeLabel() {
            const val = document.getElementById('threshold').value;
            document.getElementById('val-threshold').innerText = val;
        }

        function saveSettings() {
            const settings = {
                threshold: parseFloat(document.getElementById('threshold').value) / 100,
                colDesc: document.getElementById('col-desc').value.toUpperCase(),
                colMaterial: document.getElementById('col-material').value.toUpperCase(),
                colLabor: document.getElementById('col-labor').value.toUpperCase()
            };
            google.script.run.setSettings(settings);
        }

        function runPricing() {
            const desc = document.getElementById('col-desc').value;
            const colMaterial = document.getElementById('col-material').value;
            const colLabor = document.getElementById('col-labor').value;
            const btn = document.getElementById('btn-run');

            btn.innerText = "Zpracov치v치m...";
            btn.disabled = true;

            google.script.run
                .withSuccessHandler(() => {
                    btn.innerText = "Ocenit ozna캜en칳 v칳b캩r";
                    btn.disabled = false;
                })
                .withFailureHandler((err) => {
                    alert("Chyba: " + err);
                    btn.innerText = "Ocenit ozna캜en칳 v칳b캩r";
                    btn.disabled = false;
                })
                .priceSelectionDual(desc, colMaterial, colLabor);
        }

        function showCandidatesManual() {
            const btn = document.getElementById('btn-candidates');
            btn.innerText = "Hled치m...";
            btn.disabled = true;

            google.script.run
                .withSuccessHandler((ctx) => {
                    btn.innerText = "游댌 Zobrazit kandid치ty pro bu켿ku";
                    btn.disabled = false;

                    if (ctx && ctx.candidates && ctx.candidates.length > 0) {
                        showCandidates(ctx);
                    } else {
                        alert("Pro tuto bu켿ku nebyly nalezeny 쮂멳n칠 kandid치ty.\n\nUjist캩te se, 쬰:\n- Stoj칤te ve sloupci Materi치l (I) nebo Pr치ce (J)\n- Ve sloupci Popis (C) je text k vyhled치n칤");
                    }
                })
                .withFailureHandler((err) => {
                    btn.innerText = "游댌 Zobrazit kandid치ty pro bu켿ku";
                    btn.disabled = false;
                    alert("Chyba: " + err);
                })
                .getActiveCellContext();
        }


        // Polling logic for "Menu automatically opened"
        function startPolling() {
            setInterval(() => {
                google.script.run.withSuccessHandler((ctx) => {
                    if (ctx) {
                        const cellKey = ctx.row + "_" + ctx.description;
                        if (cellKey !== lastCellKey) {
                            lastCellKey = cellKey;
                            showCandidates(ctx);
                        }
                    } else {
                        document.getElementById('selection-panel').style.display = 'none';
                        lastCellKey = "";
                    }
                }).getActiveCellContext();
            }, 1500);
        }

        function showCandidates(ctx) {
            const panel = document.getElementById('selection-panel');
            const container = document.getElementById('candidates-container');
            const targetInfo = document.getElementById('target-info');

            targetInfo.innerText = "Polo쬶a: " + ctx.description;
            container.innerHTML = "";
            panel.style.display = 'block';

            ctx.candidates.forEach(cand => {
                const item = document.createElement('div');
                item.className = 'candidate-item';

                const priceField = ctx.type === 'labor' ? 'price_labor' : 'price_material';
                const price = (cand[priceField] || 0).toLocaleString('cs-CZ');
                const score = Math.round((cand.match_score || 0) * 100);

                item.innerHTML = `
                    <span class="candidate-name">${cand.item}</span>
                    <div class="candidate-meta">
                        <span>Cena: <b>${price} K캜</b></span>
                        <span class="candidate-score">${score}%</span>
                    </div>
                    <div class="candidate-meta" style="margin-top:4px;">
                        <span class="candidate-source">游늯 ${cand.source}</span>
                        <span>游늰 ${cand.date || '---'}</span>
                    </div>
                `;

                item.onclick = () => {
                    google.script.run.applyCandidate(ctx.row, cand, ctx.type, ctx.description);
                    panel.style.display = 'none';
                    lastCellKey = "";
                };

                container.appendChild(item);
            });
        }



        function loadFromCell() {
            google.script.run.withSuccessHandler((value) => {
                if (value) {
                    document.getElementById('hist-search').value = value;
                    document.getElementById('custom-name').value = value;
                }
            }).getActiveCellValue();
        }

        function blacklistItem() {
            if (!confirm("Opravdu chcete tuto polo쬶u smazat z cloudu?")) return;
            google.script.run.withSuccessHandler((itemId) => {
                if (!itemId) return alert("Ozna캜te ocen캩nou bu켿ku s pozn치mkou.");
                google.script.run.withSuccessHandler((r) => {
                    if (r.success) alert("Polo쬶a byla 칰sp캩코n캩 smaz치na."); else alert("Chyba: " + r.error);
                }).deleteItem(itemId);
            }).getItemIdFromActiveCell();
        }

        function addCustomPrice() {
            const name = document.getElementById('custom-name').value;
            const priceMat = parseFloat(document.getElementById('custom-price-mat').value) || 0;
            const priceLab = parseFloat(document.getElementById('custom-price-lab').value) || 0;
            if (!name) return alert("Zadejte pros칤m n치zev.");

            const btn = document.getElementById('btn-add');
            btn.innerText = "Ukl치d치m..."; btn.disabled = true;

            google.script.run
                .withSuccessHandler((r) => {
                    btn.innerText = "Ulo쬴t do datab치ze"; btn.disabled = false;
                    if (r.success) {
                        alert("Polo쬶a byla ulo쬰na!");
                        document.getElementById('custom-name').value = '';
                        document.getElementById('custom-price-mat').value = '';
                        document.getElementById('custom-price-lab').value = '';
                    } else alert("Chyba: " + r.error);
                })
                .addCustomItem(name, priceMat, priceLab, 'ks');
        }

        function showHistory() {
            const query = document.getElementById('hist-search').value;
            if (!query) return;
            const btn = document.getElementById('btn-hist');
            btn.innerText = "Hled치m..."; btn.disabled = true;

            google.script.run
                .withSuccessHandler((data) => {
                    btn.innerText = "Zobrazit v칳voj ceny"; btn.disabled = false;
                    if (data && data.history) renderChart(data.itemName, data.history);
                    else alert("Pro tuto polo쬶u nebyla nalezena 쮂멳n치 data.");
                })
                .withFailureHandler(() => { btn.innerText = "Zobrazit v칳voj ceny"; btn.disabled = false; })
                .getItemHistory(query);
        }

        function renderChart(itemName, historyData) {
            document.getElementById('chart-container').style.display = 'block';
            document.getElementById('chart-title').innerText = itemName + ' (Materi치l)';
            const ctx = document.getElementById('priceChart').getContext('2d');

            // Filter only entries with material price > 0
            const materialData = historyData.filter(row => row.price_material > 0);

            // Table - only material prices
            let tableHtml = '<table class="comp-table"><tr><th>Zdroj</th><th>Datum</th><th>Cena Mat.</th></tr>';
            const sortedTable = [...materialData].sort((a, b) => new Date(b.date) - new Date(a.date));
            sortedTable.forEach(row => {
                const price = row.price_material.toLocaleString('cs-CZ');
                tableHtml += `<tr><td>${row.vendor || 'Intern칤'}</td><td>${row.date || '---'}</td><td style="font-weight:600;color:var(--google-blue)">${price} K캜</td></tr>`;
            });
            document.getElementById('comparison-table').innerHTML = tableHtml + '</table>';

            // Chart - only material prices
            const sortedChart = [...materialData].sort((a, b) => new Date(a.date) - new Date(b.date));
            if (myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedChart.map(d => d.date),
                    datasets: [{
                        data: sortedChart.map(d => d.price_material),
                        borderColor: '#1a73e8',
                        backgroundColor: 'rgba(26, 115, 232, 0.1)',
                        fill: true,
                        tension: 0.2,
                        pointRadius: 3
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { display: false }, ticks: { display: false } },
                        y: { grid: { color: '#f0f0f0' }, ticks: { color: '#70757a', font: { size: 10 } } }
                    }
                }
            });
        }

        setInterval(() => {
            google.script.run.withSuccessHandler((status) => {
                const dot = document.getElementById('status-dot');
                const text = document.getElementById('status-text');
                if (status && status.total_items !== undefined) {
                    dot.className = 'pulse online';
                    text.innerText = 'Server p콏ipojen (' + status.total_items + ' polo쬰k)';
                } else { dot.className = 'pulse offline'; text.innerText = 'Server odpojen'; }
            }).getBackendStatus();
        }, 5000);
    </script>
</body>

</html>